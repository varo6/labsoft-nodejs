<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2023-05-25 jue 19:58 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>&lrm;</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Antonio Manuel" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2020 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org11d56f5">1. Visor de correo eléctronico: NodeJs + SQLite + AngularJs</a></li>
<li><a href="#orgbb31435">2. Base de datos con SQLite</a>
<ul>
<li><a href="#orgb3cbb4d">2.1. Modelo Entidad-Relación</a></li>
<li><a href="#orgc2806ed">2.2. Tabla de usuarios de correo</a></li>
<li><a href="#orgcf43e62">2.3. Tabla con lista de correos recibidos</a></li>
<li><a href="#org700006d">2.4. Tabla con contenidos de correo</a></li>
<li><a href="#orgcb6f5f6">2.5. Consultas sobre la base de datos</a>
<ul>
<li><a href="#org5bd79ef">2.5.1. Obtener el ID de un usuario</a></li>
<li><a href="#org4d6b505">2.5.2. Listar los correos de un usuario</a></li>
<li><a href="#orgabf34c3">2.5.3. Obtener el contenido de un correo</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org554af11">3. API ReST, interfaz cliente/servidor</a>
<ul>
<li><a href="#orgdf63d06">3.1. Identificación del usuario</a></li>
<li><a href="#org076a52b">3.2. Petición de la lista de correos</a></li>
<li><a href="#org12e5ea6">3.3. Petición del contenido de un correo.</a></li>
</ul>
</li>
<li><a href="#org5fa9477">4. Servidor http basado en NodeJS</a>
<ul>
<li><a href="#org1ead23a">4.1. npm: el gestor de paquetes de NodeJS</a></li>
<li><a href="#org1597763">4.2. Lanzar el servidor Express y probar que funciona.</a></li>
<li><a href="#org7fcaafd">4.3. Gestion de sesiones de usuario.</a></li>
<li><a href="#org6e3ef53">4.4. Procesado de peticiones POST.</a></li>
<li><a href="#org7331455">4.5. Configuracion de las rutas del API ReST</a></li>
<li><a href="#orgcf9321c">4.6. Configuración de rutas estáticas.</a></li>
</ul>
</li>
<li><a href="#org914b60c">5. Uso de SQLite con NodeJs</a>
<ul>
<li><a href="#org67d2d0a">5.1. Carga del módulo y conexión con la base de datos</a></li>
</ul>
</li>
<li><a href="#org37cd59c">6. Ejercicios:</a></li>
<li><a href="#org74b9134">7. Soluciones:</a>
<ul>
<li><a href="#orgeb6303d">7.1. Volcado de la base de datos SQLite3</a></li>
<li><a href="#org314fc28">7.2. Servidor HTTP</a></li>
<li><a href="#org28a1e84">7.3. Controladores AngularJS</a></li>
<li><a href="#orgbc8e992">7.4. Plantillas HTML</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-org11d56f5" class="outline-2">
<h2 id="org11d56f5"><span class="section-number-2">1</span> Visor de correo eléctronico: NodeJs + SQLite + AngularJs</h2>
<div class="outline-text-2" id="text-1">
<p>
Veremos en esta sesión el proceso completo de creación de una
mini-aplicación WEB para el acceso a nuestro correo electrónico.
</p>

<p>
Este ejercicio es continuacion del ejemplo visto con AngularJS,
completado con el lado del servidor y la base de datos que contiene
la información.
</p>
</div>
</div>


<div id="outline-container-orgbb31435" class="outline-2">
<h2 id="orgbb31435"><span class="section-number-2">2</span> Base de datos con SQLite</h2>
<div class="outline-text-2" id="text-2">
<p>
Para mantener la información de los usuarios de nuestra aplicación
WEB es necesario hacer uso de una SGBD, que puede ser SQL o NO-SQL,
en este ejemplo se usara SQLite por ser simple, de uso muy
extendido, y no requerir instalación. Toda la base de datos se
mantiene en un único fichero.
</p>
</div>

<div id="outline-container-orgb3cbb4d" class="outline-3">
<h3 id="orgb3cbb4d"><span class="section-number-3">2.1</span> Modelo Entidad-Relación</h3>
<div class="outline-text-3" id="text-2-1">
<p>
Para almacenar la información de los emails recibidos por cad
usuario hemos diseñado una base de datos basada en el siguiente
modelo Entidad-Relación.
</p>

<p>
Tenemos únicamente tres instancias {users, emails, contents}.
</p>

<p>
En este ejercicio crearemos nuestra base de datos en el fichero
<i>emails.db</i> Eliminamos el fichero de base de datos para crear uno
vacio más adelante.
</p>

<div class="org-src-container">
<pre class="src src-bash">rm -f emails.db
sqlite emails.db
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc2806ed" class="outline-3">
<h3 id="orgc2806ed"><span class="section-number-3">2.2</span> Tabla de usuarios de correo</h3>
<div class="outline-text-3" id="text-2-2">
<p>
Introducimos las siguientes sentencias SQL para crear la tabla de
usuarios e insertar unos cuantos registros.
</p>

<div class="org-src-container">
<pre class="src src-sqlite"><span style="color: #00bfff;">create</span> <span style="color: #00bfff;">table</span> <span style="color: #daa520;">users</span> (
  id <span style="color: #98f5ff;">integer</span> <span style="color: #00bfff;">not</span> <span style="color: #00bfff;">null</span> <span style="color: #00bfff;">primary</span> <span style="color: #00bfff;">key</span> autoincrement,
  login text <span style="color: #00bfff;">not</span> <span style="color: #00bfff;">null</span>,
  <span style="color: #00bfff;">name</span> text <span style="color: #00bfff;">not</span> <span style="color: #00bfff;">null</span>,
  email text <span style="color: #00bfff;">not</span> <span style="color: #00bfff;">null</span>,
  passwd text <span style="color: #00bfff;">not</span> <span style="color: #00bfff;">null</span>
);

<span style="color: #00bfff;">insert</span> <span style="color: #00bfff;">into</span> users <span style="color: #00bfff;">values</span> (1, <span style="color: #deb887;">'admin'</span>, <span style="color: #deb887;">'Administrador'</span>, <span style="color: #deb887;">'root@mywebmail.com'</span>, <span style="color: #deb887;">'admin'</span>);
<span style="color: #00bfff;">insert</span> <span style="color: #00bfff;">into</span> users <span style="color: #00bfff;">values</span> (2, <span style="color: #deb887;">'pepelu'</span>, <span style="color: #deb887;">'Jose Luis'</span>, <span style="color: #deb887;">'pepelu@mywebmail.com'</span>, <span style="color: #deb887;">'abracadabra'</span>);
<span style="color: #00bfff;">insert</span> <span style="color: #00bfff;">into</span> users <span style="color: #00bfff;">values</span> (3, <span style="color: #deb887;">'tonio'</span>, <span style="color: #deb887;">'Antonio Sanchez'</span>, <span style="color: #deb887;">'a.sanchez@mywebmail.com'</span>, <span style="color: #deb887;">'patata-1234'</span>);
<span style="color: #00bfff;">insert</span> <span style="color: #00bfff;">into</span> users <span style="color: #00bfff;">values</span> (4, <span style="color: #deb887;">'lamari'</span>, <span style="color: #deb887;">'Mari Carmen Mart&#237;nez'</span>, <span style="color: #deb887;">'mc.martinez@mywebmail.com'</span>, <span style="color: #deb887;">'veteasaber'</span>);
<span style="color: #00bfff;">insert</span> <span style="color: #00bfff;">into</span> users <span style="color: #00bfff;">values</span> (5, <span style="color: #deb887;">'donjl'</span>, <span style="color: #deb887;">'Juan lopez'</span>, <span style="color: #deb887;">'juan.lopez@mywebmail.com'</span>, <span style="color: #deb887;">'G7x[-%az/'</span>);
</pre>
</div>
</div>
</div>

<div id="outline-container-orgcf43e62" class="outline-3">
<h3 id="orgcf43e62"><span class="section-number-3">2.3</span> Tabla con lista de correos recibidos</h3>
<div class="outline-text-3" id="text-2-3">
<p>
Asociado a cada usuario existe una lista de correos
recibidos. Introducimos en la interfaz de SQLite los siguientes
comandos para crear la tabla de correos y agregar unos cuantos
registros a cada usuario.
</p>

<div class="org-src-container">
<pre class="src src-sqlite"><span style="color: #00bfff;">create</span> <span style="color: #00bfff;">table</span> <span style="color: #daa520;">emails</span> (
  id <span style="color: #98f5ff;">integer</span> <span style="color: #00bfff;">not</span> <span style="color: #00bfff;">null</span> <span style="color: #00bfff;">primary</span> <span style="color: #00bfff;">key</span> autoincrement,
  <span style="color: #f08080;">user</span> <span style="color: #98f5ff;">integer</span> <span style="color: #00bfff;">not</span> <span style="color: #00bfff;">null</span>,
  subject text <span style="color: #00bfff;">not</span> <span style="color: #00bfff;">null</span>,
  sender text <span style="color: #00bfff;">not</span> <span style="color: #00bfff;">null</span>,
  sentdate text <span style="color: #00bfff;">not</span> <span style="color: #00bfff;">null</span>,
  <span style="color: #00bfff;">foreign</span> <span style="color: #00bfff;">key</span>(<span style="color: #f08080;">user</span>) <span style="color: #00bfff;">references</span> users(id)
);

<span style="color: #00bfff;">insert</span> <span style="color: #00bfff;">into</span> emails <span style="color: #00bfff;">values</span> (1, 2, <span style="color: #deb887;">'Revision contrato'</span>, <span style="color: #deb887;">'jp.garcia@terra.com'</span>, <span style="color: #deb887;">'2022-01-13 12:50:10'</span>);
<span style="color: #00bfff;">insert</span> <span style="color: #00bfff;">into</span> emails <span style="color: #00bfff;">values</span> (2, 1, <span style="color: #deb887;">'fwd: apuntes informatica'</span>, <span style="color: #deb887;">'miguelsanchez98@alumno.upct.es'</span>, <span style="color: #deb887;">'2022-01-13 12:50:10'</span>);
<span style="color: #00bfff;">insert</span> <span style="color: #00bfff;">into</span> emails <span style="color: #00bfff;">values</span> (3, 3, <span style="color: #deb887;">'Inscripci&#243;n jornadas tecnicas'</span>, <span style="color: #deb887;">'marisa77@gmail.com'</span>, <span style="color: #deb887;">'2022-01-13 12:50:10'</span>);
<span style="color: #00bfff;">insert</span> <span style="color: #00bfff;">into</span> emails <span style="color: #00bfff;">values</span> (4, 2, <span style="color: #deb887;">'confirmacion compra'</span>, <span style="color: #deb887;">'compras@amazon.es'</span>, <span style="color: #deb887;">'2022-01-13 12:50:10'</span>);
<span style="color: #00bfff;">insert</span> <span style="color: #00bfff;">into</span> emails <span style="color: #00bfff;">values</span> (5, 5, <span style="color: #deb887;">'Calificaciones examen'</span>, <span style="color: #deb887;">'profesor@lis.upct.es'</span>, <span style="color: #deb887;">'2022-01-13 12:50:10'</span>);
<span style="color: #00bfff;">insert</span> <span style="color: #00bfff;">into</span> emails <span style="color: #00bfff;">values</span> (6, 4, <span style="color: #deb887;">'Bizcocho casero'</span>, <span style="color: #deb887;">'abuela.angela@gmail.com'</span>, <span style="color: #deb887;">'2022-01-13 12:50:10'</span>);
<span style="color: #00bfff;">insert</span> <span style="color: #00bfff;">into</span> emails <span style="color: #00bfff;">values</span> (7, 3, <span style="color: #deb887;">'Fotos viaje'</span>, <span style="color: #deb887;">'mar.sanchez@hotmail.com'</span>, <span style="color: #deb887;">'2022-01-13 12:50:10'</span>);
</pre>
</div>
</div>
</div>

<div id="outline-container-org700006d" class="outline-3">
<h3 id="org700006d"><span class="section-number-3">2.4</span> Tabla con contenidos de correo</h3>
<div class="outline-text-3" id="text-2-4">
<p>
La tabla anterior contiene los datos comunes a mostrar en la lista
de correos recibidos para cada usuario. Sin embargo, cada correo
tienen tambien un contenido en forma de texto que, en nuestro
diseño de base de datos, se encuentra en una tabla especifica para
el contenido de cada correo. La clave primaria es la misma que en
la tabla anterior, puesto que debe haber un registro en esta tabla
por cada registro de la tabla anterior.
</p>

<p>
Introducimos las siguientes sentencias en la interfaz de SQLite
para crear la última tabla y agregar algunos registros a la base de
datos.
</p>

<div class="org-src-container">
<pre class="src src-sqlite"><span style="color: #00bfff;">create</span> <span style="color: #00bfff;">table</span> <span style="color: #daa520;">contents</span> (
  id <span style="color: #98f5ff;">integer</span> <span style="color: #00bfff;">not</span> <span style="color: #00bfff;">null</span> <span style="color: #00bfff;">primary</span> <span style="color: #00bfff;">key</span> <span style="color: #00bfff;">unique</span>,
  content text <span style="color: #00bfff;">not</span> <span style="color: #00bfff;">null</span>,
  <span style="color: #00bfff;">foreign</span> <span style="color: #00bfff;">key</span>(id) <span style="color: #00bfff;">references</span> emails(id)
);

<span style="color: #00bfff;">insert</span> <span style="color: #00bfff;">into</span> contents <span style="color: #00bfff;">values</span> (1, <span style="color: #deb887;">'Hola jose, env&#237;a el documento del contrato que lo revise, gracias.'</span>);
<span style="color: #00bfff;">insert</span> <span style="color: #00bfff;">into</span> contents <span style="color: #00bfff;">values</span> (2, <span style="color: #deb887;">'te adjunto los apuntes de clase y el temario'</span>);
<span style="color: #00bfff;">insert</span> <span style="color: #00bfff;">into</span> contents <span style="color: #00bfff;">values</span> (3, <span style="color: #deb887;">'Esimado Antonio, le informo que el plazo para la inscripcion finaliza el 30 de mayo.'</span>);
<span style="color: #00bfff;">insert</span> <span style="color: #00bfff;">into</span> contents <span style="color: #00bfff;">values</span> (4, <span style="color: #deb887;">'Su compra se ha realizado correctamente. Gracias'</span>);
<span style="color: #00bfff;">insert</span> <span style="color: #00bfff;">into</span> contents <span style="color: #00bfff;">values</span> (5, <span style="color: #deb887;">'Estimados alumnos, en el aula virtual pueden en contrar las calificaiones del examen'</span>);
<span style="color: #00bfff;">insert</span> <span style="color: #00bfff;">into</span> contents <span style="color: #00bfff;">values</span> (6, <span style="color: #deb887;">'Hola mari, aqui te paso la receta del bizcocho ese que tanto te gusta'</span>);
<span style="color: #00bfff;">insert</span> <span style="color: #00bfff;">into</span> contents <span style="color: #00bfff;">values</span> (7, <span style="color: #deb887;">'Antonio, en mi google-drive tienes las fotos del ultimo viaje.'</span>);
</pre>
</div>
</div>
</div>

<div id="outline-container-orgcb6f5f6" class="outline-3">
<h3 id="orgcb6f5f6"><span class="section-number-3">2.5</span> Consultas sobre la base de datos</h3>
<div class="outline-text-3" id="text-2-5">
<p>
Sobre esta base de datos se pueden realizar las siguientes consultas:
</p>

<ul class="org-ul">
<li>obtener el identificador de un usuario.</li>
<li>comprobar si la contraseña es correcta.</li>
<li>obtener la lista de correos recibidos por un usuario.</li>
<li><p>
obtener el contenido de un mensaje de correo.
</p>

<p>
Veamos ahora con detalle algunos de estos casos.
</p></li>
</ul>
</div>

<div id="outline-container-org5bd79ef" class="outline-4">
<h4 id="org5bd79ef"><span class="section-number-4">2.5.1</span> Obtener el ID de un usuario</h4>
<div class="outline-text-4" id="text-2-5-1">
<div class="org-src-container">
<pre class="src src-sqlite"><span style="color: #00bfff;">SELECT</span> id <span style="color: #00bfff;">FROM</span> users <span style="color: #00bfff;">WHERE</span> email = <span style="color: #deb887;">'a.sanchez@mywebmail.com'</span>;
</pre>
</div>
</div>
</div>

<div id="outline-container-org4d6b505" class="outline-4">
<h4 id="org4d6b505"><span class="section-number-4">2.5.2</span> Listar los correos de un usuario</h4>
<div class="outline-text-4" id="text-2-5-2">
<div class="org-src-container">
<pre class="src src-sqlite"><span style="color: #00bfff;">SELECT</span> * <span style="color: #00bfff;">FROM</span> emails <span style="color: #00bfff;">WHERE</span> <span style="color: #f08080;">user</span> = 3;
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-right" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">id</th>
<th scope="col" class="org-right">user</th>
<th scope="col" class="org-left">subject</th>
<th scope="col" class="org-left">sender</th>
<th scope="col" class="org-left">sentdate</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">3</td>
<td class="org-right">3</td>
<td class="org-left">Inscripción jornadas tecnicas</td>
<td class="org-left">marisa77@gmail.com</td>
<td class="org-left">2022-01-13 12:50:10</td>
</tr>

<tr>
<td class="org-right">7</td>
<td class="org-right">3</td>
<td class="org-left">Fotos viaje</td>
<td class="org-left">mar.sanchez@hotmail.com</td>
<td class="org-left">2022-01-13 12:50:10</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-orgabf34c3" class="outline-4">
<h4 id="orgabf34c3"><span class="section-number-4">2.5.3</span> Obtener el contenido de un correo</h4>
<div class="outline-text-4" id="text-2-5-3">
<div class="org-src-container">
<pre class="src src-sqlite"><span style="color: #00bfff;">SELECT</span> * <span style="color: #00bfff;">FROM</span> contents <span style="color: #00bfff;">WHERE</span> id = 7;
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">id</th>
<th scope="col" class="org-left">content</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">7</td>
<td class="org-left">Antonio, en mi google-drive tienes las fotos del ultimo viaje.</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>

<div id="outline-container-org554af11" class="outline-2">
<h2 id="org554af11"><span class="section-number-2">3</span> API ReST, interfaz cliente/servidor</h2>
<div class="outline-text-2" id="text-3">
<p>
Para nuestra mini aplicación WEB definiremos una API ReST basada en
tres acciones.
</p>

<ul class="org-ul">
<li>El registro/identificación de un usuario. Antes de empezar a usar
el servidor cualquier usuario se debe de identificar
correctamente, proporcionando el nombre de usuario y su
contraseña.</li>
<li>Petición de la lista completa de correos almacenados en la base de
datos. Una vez que un usuario se ha identificado, se puede
solicitar tantas veces como se desee la lista de correos
recibidos.</li>
<li>Petición del contenido de un correo. En el navegador del usuario
se mostraría la lsta de todos los correos y el usuario podría
seleccionar uno para ver su contenido, en ese momento se puede
solicitar el contenido de ese correo mediante esta función del API
ReST.</li>
</ul>

<p>
Este capítulo es puramente descriptivo, simplemente se describe el
API ReST que deberá implementar el servidor. La descripción se hace
mediante ejemplos de peticiones válidas y la descripción lo que
deberá responder el servidor en cada petición.
</p>

<p>
No es necesario hacer ni probar nada por ahora, solo entender las
diferentes funciones proporcionadas por el API ReST de nuestro
servidor HTTP de ejemplo.
</p>
</div>

<div id="outline-container-orgdf63d06" class="outline-3">
<h3 id="orgdf63d06"><span class="section-number-3">3.1</span> Identificación del usuario</h3>
<div class="outline-text-3" id="text-3-1">
<p>
Para que un usuario pueda utilizar esta aplicación debe primero
identificarse. Así tendrá acceso exclusivamente a sus correos
electrónicos. No es correcto que un usuario tenga acceso a los
correos de otros usuarios. El servidor solo podrá enviar al cliente
WEB la información del usuario que se haya identificado
correctamente.
</p>

<p>
Desde el navegador, se deberá enviar una petición HTTP POST con los
siguientes parámetros.
</p>

<div class="org-src-container">
<pre class="src src-js">$http({
  method: <span style="color: #deb887;">'POST'</span>,
  url: <span style="color: #deb887;">'/login'</span>,
  data: {
    user: <span style="color: #deb887;">'username'</span>,
    passwd: <span style="color: #deb887;">'userpasswd'</span>
  }
})
</pre>
</div>

<p>
Al recibir esta petición, el servidor deberá comprobar que los
datos aportados en la petición se corresponden con los de un
usuario registrado en la base de datos. Deberá buscar el nombre de
usuario y si existe entonces comprobar que la contraseña es la
correcta.
</p>

<p>
En caso de éxito, el servidor guardará una <i>cookie</i> asociada a este
usuario y responderá al cliente con un objeto JSON que contiene los
datos del usuario que se ha identificado.
</p>

<p>
Para una petición como esta:
</p>

<div class="org-src-container">
<pre class="src src-js">$http({
  method: <span style="color: #deb887;">'POST'</span>,
  url: <span style="color: #deb887;">'/login'</span>,
  data: {
    user: <span style="color: #deb887;">'donjl'</span>,
    passwd: <span style="color: #deb887;">'G7x[-%az/'</span>
  }
})
</pre>
</div>

<p>
el servidor responderá con el siguiente objeto JSON:
</p>

<div class="org-src-container">
<pre class="src src-js">{
   id: 5,
   login: <span style="color: #deb887;">'donjl'</span>,
   name: <span style="color: #deb887;">'Juan lopez'</span>,
   email: <span style="color: #deb887;">'juan.lopez@mywebmail.com'</span>
}
</pre>
</div>

<p>
En caso de fallo el servidor enviará un mensaje de error adecuado.
</p>
</div>
</div>

<div id="outline-container-org076a52b" class="outline-3">
<h3 id="org076a52b"><span class="section-number-3">3.2</span> Petición de la lista de correos</h3>
<div class="outline-text-3" id="text-3-2">
<p>
Una vez un usuario se ha registrado en el servidor podrá solicitar
la lista de sus correos recibidos mediante la siguiente petición:
</p>

<div class="org-src-container">
<pre class="src src-js">$http.get(<span style="color: #deb887;">'/list'</span>);
</pre>
</div>

<p>
La <i>cookie</i> en el servidor identifica al usuario cuyos correos se
solicitan.  Para ello se habrá guardado en los datos de la sesión
el id del usuario tras haber logrado registrarse correctamente.
</p>

<p>
El servidor responderá con la lista de mensajes de correo para ese
usuario en formato JSON.
</p>

<p>
Ejemplo de petición para el usuario '3' que fue registrado
previamente.
</p>

<pre class="example">
http://localhost/list
</pre>

<p>
Se obtendrá la siguiente respuesta:
</p>

<div class="org-src-container">
<pre class="src src-js">[
  {
    id : 3,
    user : 3,
    subject : <span style="color: #deb887;">'Inscripci&#243;n jornadas tecnicas'</span>,
    sender : <span style="color: #deb887;">'marisa77@gmail.com'</span>,
    sentdate : <span style="color: #deb887;">'2022-01-13 12:50:10'</span>
  },
  {
    id : 7,
    user : 3,
    subject : <span style="color: #deb887;">'Fotos viaje'</span>,
    sender : <span style="color: #deb887;">'mar.sanchez@hotmail.com'</span>,
    sentdate : <span style="color: #deb887;">'2022-01-13 12:50:10'</span>
  }
]
</pre>
</div>

<p>
En la respuesta el servidor envía un vector con los datos de los
correos de este usuario. Se puede comprobar en esta respuesta que
en todos los elementos, el atributo <i>user</i> contiene el <i>id</i> del
usuario que hace la petición. Mientras que el atributo <i>id</i> que hay
en cada elemento de la respuesta es el identificador (clave
primaria) de cada uno de los correos recibidos. Es mediante este
identificador con el que se podrán solicitar el resto de datos del
correo.
</p>
</div>
</div>

<div id="outline-container-org12e5ea6" class="outline-3">
<h3 id="org12e5ea6"><span class="section-number-3">3.3</span> Petición del contenido de un correo.</h3>
<div class="outline-text-3" id="text-3-3">
<p>
Para que el frontal WEB pueda mostrar el contenido de uno de esos
correos deberá solicitarlo al servidor mediante la petición
seguiente:
</p>

<p>
Al igual que en el caso anterior, el identificador del usuario
registrado se encuentra en los datos asociados a la sesión abierta
con el servidor.
</p>

<div class="org-src-container">
<pre class="src src-js">$http.get(<span style="color: #deb887;">'/email/:id'</span>);
</pre>
</div>

<p>
Para la petición en la que se asume el usuario con identificador
'3':
</p>

<pre class="example">
http://localhost/email/7
</pre>

<p>
Se obtendría la respuesta:
</p>

<div class="org-src-container">
<pre class="src src-js">{
  id : 7,
  content : <span style="color: #deb887;">'antonio, en mi google-drive tienes las fotos del ultimo viaje.'</span>
}
</pre>
</div>

<p>
Si intencionadamente un usuario distinto del '3', realiza la misma
petición, el servidor devolverá un código de error mediante uno de
los siguientes mensajes:
</p>

<ul class="org-ul">
<li>No está autorizado.</li>
<li>El recurso solicitado no existe.</li>
<li>Petición mal conformada.</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-org5fa9477" class="outline-2">
<h2 id="org5fa9477"><span class="section-number-2">4</span> Servidor http basado en NodeJS</h2>
<div class="outline-text-2" id="text-4">
<p>
Nodejs es un inteprete de javascript. se han desarrollado multitud
de paquetes y librerias para poder construir aplicaciones en
javascript que usan bases de datos relacionales, como mysql,
postgress, mariadb, sqlite y tambien nosql como mongodb, berkeleydb
y otras.
</p>

<p>
Tambien existen librerias que implementan los distintos protocolos
de internet, como express que implementa un servidor http y que será
el que usaremos en este ejercicio.
</p>
</div>

<div id="outline-container-org1ead23a" class="outline-3">
<h3 id="org1ead23a"><span class="section-number-3">4.1</span> npm: el gestor de paquetes de NodeJS</h3>
<div class="outline-text-3" id="text-4-1">
<p>
NodeJS incorpora un gestor de paquetes de código en JavaScript con
el que podremos instalarnos en nuestro equipo de desarrollo todas
aquellas librerias que necesitemos.
</p>

<p>
Instalaremos en nuestro directorio los paquetes:
</p>
<dl class="org-dl">
<dt>Express</dt><dd>Servidor HTTP en JavaScript</dd>
<dt>SQlite3</dt><dd>Driver para el acceso a bases de datos SQLite3</dd>
<dt>Express Session</dt><dd>Para la gestion de sesiones mediante <i>cookies</i></dd>
<dt>Body Parser</dt><dd>Para la extracción de los parámetros en la URL</dd>
</dl>

<p>
En el mismo directorio en el que hayamos creado nuestra base de
datos vamos a programar nuestro servidor HTTP. Para ello, en primer
lugar, ejecutamos los siguientes comandos desde la ventana de
comandos del sistema, estando situados en el directorio adecuado.
</p>

<div class="org-src-container">
<pre class="src src-sh">npm install express
npm install sqlite3
npm install express-session
npm install body-parser
</pre>
</div>

<p>
Una vez instalados estos paquetes podemos empezar a usarlos.
</p>
</div>
</div>

<div id="outline-container-org1597763" class="outline-3">
<h3 id="org1597763"><span class="section-number-3">4.2</span> Lanzar el servidor Express y probar que funciona.</h3>
<div class="outline-text-3" id="text-4-2">
<p>
Cree un fichero y escriba el siguiente código:
</p>

<div class="org-src-container">
<pre class="src src-js"><span style="color: #deb887;">'use strict'</span>;

<span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">Cargamos el modulo de Express</span>
<span style="color: #00bfff;">const</span> <span style="color: #4eee94;">express</span> = require(<span style="color: #deb887;">'express'</span>);

<span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">Creamos un objeto servidor HTTP</span>
<span style="color: #00bfff;">const</span> <span style="color: #4eee94;">server</span> = express();

<span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">Definimos el puerto a usar por el servidor HTTP</span>
<span style="color: #00bfff;">const</span> <span style="color: #4eee94;">port</span> = 8080;

<span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">Configuramos la ruta / en el servidor HTTP para que devuelva un saludo</span>
server.get(<span style="color: #deb887;">'/'</span>, (req, res) =&gt; {
  res.send(<span style="color: #deb887;">'Hello World!'</span>)
});

<span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">Poner en marcha el servidor</span>
server.listen(port, () =&gt; {
  console.log(<span style="color: #deb887;">`Servidor corriendo en el puerto ${port}`</span>);
});
</pre>
</div>

<p>
Ahora simplemente le decimos a NodeJs que ejecute este programa en
JavaScript. Tecleamos el siguiente comando desde la linea de comandos.
</p>

<div class="org-src-container">
<pre class="src src-sh">node server.js
</pre>
</div>

<p>
Si ahora abrimos el navegador y nos conectamos a la URL
</p>

<pre class="example">
http://localhost:8080/
</pre>

<p>
Veremos la respuesta de nuestro servidor.
</p>
</div>
</div>

<div id="outline-container-org7fcaafd" class="outline-3">
<h3 id="org7fcaafd"><span class="section-number-3">4.3</span> Gestion de sesiones de usuario.</h3>
<div class="outline-text-3" id="text-4-3">
<p>
Un mecanismo básico del protocolo HTTP para la gestion de sesiones
de usuario se basa en la emision de <i>cookies</i> por parte del
servidor que se guardan en el navegador del usuario y que se
utilizan para identificar al mismo usuario entre diferentes
peticiones.
</p>

<p>
Express proporciona un modulo que puede ser usado con este fin.
</p>

<div class="org-src-container">
<pre class="src src-js"><span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">Cargamos el modulo para la gestion de sesiones</span>
<span style="color: #00bfff;">const</span> <span style="color: #4eee94;">session</span> = require(<span style="color: #deb887;">'express-session'</span>);

<span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">Creamos el objeto con la configuraci&#243;n</span>
<span style="color: #00bfff;">var</span> <span style="color: #4eee94;">sesscfg</span> = {
  secret: <span style="color: #deb887;">'inventate-una-buena-contrase&#241;a-aqui'</span>,
  resave: <span style="color: #a2cd5a;">false</span>,
  saveUninitialized: <span style="color: #a2cd5a;">true</span>,
  cookie: { maxAge: 8*60*60*1000 } <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">8 working hours</span>
};

<span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">Se le dice al servidor que use el modulo de sesiones con esa configuracion</span>
server.use(session(sesscfg));

<span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">Poner en marcha el servidor ...</span>
</pre>
</div>

<p>
Fijarse bien en configurar la sesión y hacer que el servidor use el
sistema de gestion de sesiones antes de poner en marcha el
servidor.
</p>
</div>
</div>

<div id="outline-container-org6e3ef53" class="outline-3">
<h3 id="org6e3ef53"><span class="section-number-3">4.4</span> Procesado de peticiones POST.</h3>
<div class="outline-text-3" id="text-4-4">
<p>
Dado que nuestro API ReST hace uso del metodo POST, será necesario
poder acceder a esos datos que no están contenidos en la URL de la
petición, y que puedan ser utilizados en las consultas a la base de
datos.
</p>

<p>
El paquete <b>body-parser</b> se encarga de procesar esta información y
ofrecerla en formato JSON como se muestra en el siguiente ejemplo:
</p>

<div class="org-src-container">
<pre class="src src-js"><span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">Obtener la referencia al m&#243;dulo 'body-parser'</span>
<span style="color: #00bfff;">const</span> <span style="color: #4eee94;">bodyParser</span> = require(<span style="color: #deb887;">'body-parser'</span>);

<span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">Configuring express to use body-parser as middle-ware.</span>
server.use(bodyParser.urlencoded({ extended: <span style="color: #a2cd5a;">false</span> }));
server.use(bodyParser.json());

<span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">Poner en marcha el servidor</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org7331455" class="outline-3">
<h3 id="org7331455"><span class="section-number-3">4.5</span> Configuracion de las rutas del API ReST</h3>
<div class="outline-text-3" id="text-4-5">
<p>
La idea básica tras un API ReST es que cada URL o ruta a un recurso
en el servidor se va a asociar a una funcionalidad que debe
proporcionar la aplicacion WEB. Esto significa que a cada ruta hay
que asociar una función en la que se implementará esa
funcionalidad.
</p>

<p>
Esta configuración se establece mediante un objeto "router"
proporcionado por el servidor express. Con ese objeto se asociará
una función a cada ruta válida.
</p>

<div class="org-src-container">
<pre class="src src-js"><span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">Obtener el configurador de rutas</span>
<span style="color: #00bfff;">const</span> <span style="color: #4eee94;">router</span> = express.Router();

<span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">Configurar la accion asociada al login</span>
router.post(<span style="color: #deb887;">'/login'</span>, <span style="color: #00bfff;">function</span>(<span style="color: #4eee94;">req</span>, <span style="color: #4eee94;">res</span>) {
     <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">Comprobar si la petici&#243;n contiene los campos ('user' y 'passwd')</span>
     <span style="color: #00bfff;">if</span> (!req.body.user || !req.body.passwd) {
         res.json({ errormsg: <span style="color: #deb887;">'Peticion mal formada'</span>});
         <span style="color: #00bfff;">return</span>;
     }
     <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">La petici&#243;n est&#225; bien formada -&gt; procesarla</span>
     <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">TODO: procesar la petic&#243;n</span>
     processLogin(req, res);
});

<span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">Configurar la accion asociada al listado de correos</span>
router.get(<span style="color: #deb887;">'/list'</span>, <span style="color: #00bfff;">function</span>(<span style="color: #4eee94;">req</span>, <span style="color: #4eee94;">res</span>) {
     <span style="color: #7f7f7f;">//</span><span style="color: #7f7f7f;">TODO: verificar los parametros de la peticion</span>
     <span style="color: #00bfff;">if</span> (verificarParametrosListar(req)) {
        <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">TODO: procesar la petici&#243;n</span>
        processListar(req, res);
        <span style="color: #00bfff;">return</span>;
     }
     res.json({ errormsg: <span style="color: #deb887;">'Peticion mal formada'</span>});
});

<span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">Configurar la accion asociada a la petici&#243;n del contenido de un correo</span>
router.get(<span style="color: #deb887;">'/email/:id'</span>, <span style="color: #00bfff;">function</span>(<span style="color: #4eee94;">req</span>, <span style="color: #4eee94;">res</span>) {
     <span style="color: #7f7f7f;">//</span><span style="color: #7f7f7f;">TODO: verificar los parametros de la peticion</span>
     <span style="color: #00bfff;">if</span> (verificarParametrosEmail(req)) {
        <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">TODO: procesar la petici&#243;n</span>
        processEmail(req, res);
        <span style="color: #00bfff;">return</span>;
     }
     res.json({ errormsg: <span style="color: #deb887;">'Peticion mal formada'</span>});
});

<span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">A&#241;adir las rutas al servidor</span>
server.use(<span style="color: #deb887;">'/'</span>, router);

<span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">Poner en marcha el servidor</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgcf9321c" class="outline-3">
<h3 id="orgcf9321c"><span class="section-number-3">4.6</span> Configuración de rutas estáticas.</h3>
<div class="outline-text-3" id="text-4-6">
<p>
Nuestro servidor web no solo debe responder a estas URL's. También
tendrá que enviar a los navegadores de los usuarios ficheros (html,
png, css, js) necesarios para la aplicación. Estos archivos se
encontrarán el algún directorio, por tanto será necesario
configurar la ruta en la que estén esos archivos para que los pueda
enviar cuando se le soliciten.
</p>

<p>
En este ejemplo se configuran las rutas estáticas indicando que
todos los archivos se encuentran en este mismo directorio:
</p>

<div class="org-src-container">
<pre class="src src-js"><span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">A&#241;adir las rutas est&#225;ticas al servidor.</span>
server.use(express.<span style="color: #00bfff;">static</span>(<span style="color: #deb887;">'.'</span>));

<span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">poner en marcha el servidor</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org914b60c" class="outline-2">
<h2 id="org914b60c"><span class="section-number-2">5</span> Uso de SQLite con NodeJs</h2>
<div class="outline-text-2" id="text-5">
<p>
Para el acceso a una base de datos SQLite desde NodeJs podemos usar
el modulo 'sqlite3' de la siguiente manera.
</p>
</div>

<div id="outline-container-org67d2d0a" class="outline-3">
<h3 id="org67d2d0a"><span class="section-number-3">5.1</span> Carga del módulo y conexión con la base de datos</h3>
<div class="outline-text-3" id="text-5-1">
<p>
Podemos establecer la conexión con nuestra base de datos antes de
configurar las rutas del servidor http, de esta manera se podrá
pasar el objeto de la conexión con la base de datos a la función
que procesa cada una de las peticiones.
</p>

<div class="org-src-container">
<pre class="src src-js"><span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">cargar el m&#243;dulo para bases de datos SQLite</span>
<span style="color: #00bfff;">var</span> <span style="color: #4eee94;">sqlite3</span> = require(<span style="color: #deb887;">'sqlite3'</span>).verbose();

<span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">Abrir nuestra base de datos</span>
<span style="color: #00bfff;">var</span> <span style="color: #4eee94;">db</span> = <span style="color: #00bfff;">new</span> <span style="color: #98f5ff;">sqlite3.Database</span>(
  <span style="color: #deb887;">'emails.db'</span>,    <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">nombre del fichero de base de datos</span>
  <span style="color: #00bfff;">function</span>(<span style="color: #4eee94;">err</span>) { <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">funcion que ser&#225; invocada con el resultado</span>
    <span style="color: #00bfff;">if</span> (err)      <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">Si ha ocurrido un error</span>
       console.log(err);  <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">Mostrarlo por la consola del servidor</span>
  }
);

<span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">Ahora la acci&#243;n asociada al login ser&#237;a:</span>
router.post(<span style="color: #deb887;">'/login'</span>, <span style="color: #00bfff;">function</span>(<span style="color: #4eee94;">req</span>, <span style="color: #4eee94;">res</span>) {
     <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">Comprobar si la petici&#243;n contiene los campos ('user' y 'passwd')</span>
     <span style="color: #00bfff;">if</span> (!req.body.user || !req.body.passwd) {
         res.json({ errormsg: <span style="color: #deb887;">'Peticion mal formada'</span>});
         <span style="color: #00bfff;">return</span>;
     }
     <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">La petici&#243;n est&#225; bien formada -&gt; procesarla</span>
     <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">TODO: procesar la petic&#243;n</span>
     processLogin(req, res, db); <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">Se la pasa tambien la base de datos</span>
});
</pre>
</div>

<p>
Este fragmento de codigo fuente crea un objeto JavaScript <code>db</code> que
está ligado a nuestra base de datos y sobre el que podemos lanzar
consultas en SQL.
</p>

<p>
Por ejemplo, para obtener la información del usuario asociado a un
<i>login</i> se usaría de la siguiente manera:
</p>

<p>
NOTA: Ten en cuenta que estamos modificando la función
<code>processLogin()</code> que hemos implementado antes, no olvides borrar la
implementación anterior que ya no sirve y sustituirla por esta.
</p>

<div class="org-src-container">
<pre class="src src-js"><span style="color: #00bfff;">function</span> <span style="color: #daa520;">processLogin</span>(<span style="color: #4eee94;">req</span>, <span style="color: #4eee94;">res</span>, <span style="color: #4eee94;">db</span>) {
  <span style="color: #00bfff;">var</span> <span style="color: #4eee94;">login</span> = req.body.user;
  <span style="color: #00bfff;">var</span> <span style="color: #4eee94;">passwd</span> = req.body.passwd;

  db.get(
    <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">consulta y par&#225;metros cuyo valor ser&#225; usado en los '?'</span>
    <span style="color: #deb887;">'SELECT * FROM users WHERE login=?'</span>, login,
    <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">funcion que se invocar&#225; con los datos obtenidos de la base de datos</span>
    <span style="color: #00bfff;">function</span>(<span style="color: #4eee94;">err</span>, <span style="color: #4eee94;">row</span>) {
       <span style="color: #00bfff;">if</span> (row == <span style="color: #a2cd5a;">undefined</span>) {
           <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">La consulta no devuelve ningun dato -: no existe el usuario</span>
           res.json({ errormsg: <span style="color: #deb887;">'El usuario no existe'</span>});
       } <span style="color: #00bfff;">else</span> <span style="color: #00bfff;">if</span> (row.passwd === passwd) {
           <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">La contrase&#241;a es correcta</span>
           <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">Asociar el userID a los datos de la sesi&#243;n</span>
           req.session.userID = row.id; <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">solo el id del usuario registrado</span>

           <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">Preparar los datos a enviar al navegador (AngularJS)</span>
           <span style="color: #00bfff;">var</span> <span style="color: #4eee94;">data</span> = {
              id: row.id,
              login: row.login,
              name: row.name,
              email: row.email
           };

           <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">enviar en la respuesta serializado en formato JSON</span>
           res.json(data);
       } <span style="color: #00bfff;">else</span> {
           <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">La contrase&#241;a no es correcta, -: enviar este otro mensaje</span>
           res.json({ errormsg: <span style="color: #deb887;">'Fallo de autenticaci&#243;n'</span>});
       }
    }
  );
}
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org37cd59c" class="outline-2">
<h2 id="org37cd59c"><span class="section-number-2">6</span> Ejercicios:</h2>
<div class="outline-text-2" id="text-6">
<p>
Complete la funcionalidad del servidor implementando las funciones:
</p>

<ul class="org-ul">
<li>processLogin(req, res, db)</li>
<li>verificarParametrosListar(req, db)</li>
<li>processListar(req, res, db)</li>
<li>verificarParametrosEmail(req, db)</li>
<li>processEmail(req, res, db)</li>
</ul>

<p>
Todas estas funciones reciben los siguientes parámetros:
</p>

<dl class="org-dl">
<dt>req</dt><dd>el objeto con los datos de la peticion.</dd>
<dt>res</dt><dd>el objeto donde alojar la respuesta.</dd>
<dt>db</dt><dd>el objeto que representa la base de datos. Sobre el que hay
que lanzar las consultas SQL y procesar los datos devueltos.</dd>
</dl>
</div>
</div>


<div id="outline-container-org74b9134" class="outline-2">
<h2 id="org74b9134"><span class="section-number-2">7</span> Soluciones:</h2>
<div class="outline-text-2" id="text-7">
</div>
<div id="outline-container-orgeb6303d" class="outline-3">
<h3 id="orgeb6303d"><span class="section-number-3">7.1</span> Volcado de la base de datos SQLite3</h3>
<div class="outline-text-3" id="text-7-1">
<p>
Se reproduce a continuación el volcado completo de la base de
datos, tal cual se obtiene mediante los comandos:
</p>

<div class="org-src-container">
<pre class="src src-sh">$ sqlite3 emails.db
SQLite version 3.37.2 2022-01-06 13:25:41
Enter <span style="color: #deb887;">".help"</span> for usage hints.
sqlite&gt; .output emails.sql
sqlite&gt; .dump
sqlite&gt; .exit
$
</pre>
</div>


<p>
#+EXPORT<sub>FILE</sub><sub>NAME</sub> emails.sql
</p>
<div class="org-src-container">
<pre class="src src-sql">PRAGMA foreign_keys=<span style="color: #00bfff;">OFF</span>;
<span style="color: #00bfff;">BEGIN</span> <span style="color: #00bfff;">TRANSACTION</span>;
<span style="color: #00bfff;">CREATE</span> <span style="color: #00bfff;">TABLE</span> <span style="color: #daa520;">users</span> (
  id <span style="color: #98f5ff;">integer</span> <span style="color: #00bfff;">not</span> <span style="color: #00bfff;">null</span> <span style="color: #00bfff;">primary</span> <span style="color: #00bfff;">key</span> autoincrement <span style="color: #00bfff;">unique</span>,
  login text <span style="color: #00bfff;">not</span> <span style="color: #00bfff;">null</span>,
  <span style="color: #00bfff;">name</span> text <span style="color: #00bfff;">not</span> <span style="color: #00bfff;">null</span>,
  email text <span style="color: #00bfff;">not</span> <span style="color: #00bfff;">null</span>,
  passwd text <span style="color: #00bfff;">not</span> <span style="color: #00bfff;">null</span>
);
<span style="color: #00bfff;">INSERT</span> <span style="color: #00bfff;">INTO</span> users <span style="color: #00bfff;">VALUES</span>(1,<span style="color: #deb887;">'admin'</span>,<span style="color: #deb887;">'Administrador'</span>,<span style="color: #deb887;">'root@mywebmail.com'</span>,<span style="color: #deb887;">'admin'</span>);
<span style="color: #00bfff;">INSERT</span> <span style="color: #00bfff;">INTO</span> users <span style="color: #00bfff;">VALUES</span>(2,<span style="color: #deb887;">'pepelu'</span>,<span style="color: #deb887;">'Jose Luis'</span>,<span style="color: #deb887;">'pepelu@mywebmail.com'</span>,<span style="color: #deb887;">'abracadabra'</span>);
<span style="color: #00bfff;">INSERT</span> <span style="color: #00bfff;">INTO</span> users <span style="color: #00bfff;">VALUES</span>(3,<span style="color: #deb887;">'tonio'</span>,<span style="color: #deb887;">'Antonio Sanchez'</span>,<span style="color: #deb887;">'a.sanchez@mywebmail.com'</span>,<span style="color: #deb887;">'patata-1234'</span>);
<span style="color: #00bfff;">INSERT</span> <span style="color: #00bfff;">INTO</span> users <span style="color: #00bfff;">VALUES</span>(4,<span style="color: #deb887;">'lamari'</span>,<span style="color: #deb887;">'Mari Carmen Mart&#237;nez'</span>,<span style="color: #deb887;">'mc.martinez@mywebmail.com'</span>,<span style="color: #deb887;">'veteasaber'</span>);
<span style="color: #00bfff;">INSERT</span> <span style="color: #00bfff;">INTO</span> users <span style="color: #00bfff;">VALUES</span>(5,<span style="color: #deb887;">'donjl'</span>,<span style="color: #deb887;">'Juan lopez'</span>,<span style="color: #deb887;">'juan.lopez@mywebmail.com'</span>,<span style="color: #deb887;">'G7x[-%az/'</span>);
<span style="color: #00bfff;">CREATE</span> <span style="color: #00bfff;">TABLE</span> <span style="color: #daa520;">emails</span> (
  id <span style="color: #98f5ff;">integer</span> <span style="color: #00bfff;">not</span> <span style="color: #00bfff;">null</span> <span style="color: #00bfff;">primary</span> <span style="color: #00bfff;">key</span> autoincrement <span style="color: #00bfff;">unique</span>,
  <span style="color: #f08080;">user</span> <span style="color: #98f5ff;">integer</span> <span style="color: #00bfff;">not</span> <span style="color: #00bfff;">null</span>,
  subject text <span style="color: #00bfff;">not</span> <span style="color: #00bfff;">null</span>,
  sender text <span style="color: #00bfff;">not</span> <span style="color: #00bfff;">null</span>,
  <span style="color: #98f5ff;">date</span> text <span style="color: #00bfff;">not</span> <span style="color: #00bfff;">null</span>
);
<span style="color: #00bfff;">INSERT</span> <span style="color: #00bfff;">INTO</span> emails <span style="color: #00bfff;">VALUES</span>(1,2,<span style="color: #deb887;">'Revision contrato'</span>,<span style="color: #deb887;">'jp.garcia@terra.com'</span>,<span style="color: #deb887;">'2022-01-13 12:50:10'</span>);
<span style="color: #00bfff;">INSERT</span> <span style="color: #00bfff;">INTO</span> emails <span style="color: #00bfff;">VALUES</span>(2,1,<span style="color: #deb887;">'fwd: apuntes informatica'</span>,<span style="color: #deb887;">'miguelsanchez98@alumno.upct.es'</span>,<span style="color: #deb887;">'2022-01-13 12:50:10'</span>);
<span style="color: #00bfff;">INSERT</span> <span style="color: #00bfff;">INTO</span> emails <span style="color: #00bfff;">VALUES</span>(3,3,<span style="color: #deb887;">'Inscripci&#243;n jornadas tecnicas'</span>,<span style="color: #deb887;">'marisa77@gmail.com'</span>,<span style="color: #deb887;">'2022-01-13 12:50:10'</span>);
<span style="color: #00bfff;">INSERT</span> <span style="color: #00bfff;">INTO</span> emails <span style="color: #00bfff;">VALUES</span>(4,2,<span style="color: #deb887;">'confirmacion compra'</span>,<span style="color: #deb887;">'compras@amazon.es'</span>,<span style="color: #deb887;">'2022-01-13 12:50:10'</span>);
<span style="color: #00bfff;">INSERT</span> <span style="color: #00bfff;">INTO</span> emails <span style="color: #00bfff;">VALUES</span>(5,5,<span style="color: #deb887;">'Calificaciones examen'</span>,<span style="color: #deb887;">'profesor@lis.upct.es'</span>,<span style="color: #deb887;">'2022-01-13 12:50:10'</span>);
<span style="color: #00bfff;">INSERT</span> <span style="color: #00bfff;">INTO</span> emails <span style="color: #00bfff;">VALUES</span>(6,4,<span style="color: #deb887;">'Bizcocho casero'</span>,<span style="color: #deb887;">'abuela.angela@gmail.com'</span>,<span style="color: #deb887;">'2022-01-13 12:50:10'</span>);
<span style="color: #00bfff;">INSERT</span> <span style="color: #00bfff;">INTO</span> emails <span style="color: #00bfff;">VALUES</span>(7,3,<span style="color: #deb887;">'Fotos viaje'</span>,<span style="color: #deb887;">'mar.sanchez@hotmail.com'</span>,<span style="color: #deb887;">'2022-01-13 12:50:10'</span>);
<span style="color: #00bfff;">CREATE</span> <span style="color: #00bfff;">TABLE</span> <span style="color: #daa520;">contents</span> (
  id <span style="color: #98f5ff;">integer</span> <span style="color: #00bfff;">not</span> <span style="color: #00bfff;">null</span> <span style="color: #00bfff;">primary</span> <span style="color: #00bfff;">key</span> <span style="color: #00bfff;">unique</span>,
  content text <span style="color: #00bfff;">not</span> <span style="color: #00bfff;">null</span>
);
<span style="color: #00bfff;">INSERT</span> <span style="color: #00bfff;">INTO</span> contents <span style="color: #00bfff;">VALUES</span>(1,<span style="color: #deb887;">'Hola jose, env&#237;a el documento del contrato que lo revise, gracias.'</span>);
<span style="color: #00bfff;">INSERT</span> <span style="color: #00bfff;">INTO</span> contents <span style="color: #00bfff;">VALUES</span>(2,<span style="color: #deb887;">'te adjunto los apuntes de clase y el temario'</span>);
<span style="color: #00bfff;">INSERT</span> <span style="color: #00bfff;">INTO</span> contents <span style="color: #00bfff;">VALUES</span>(3,<span style="color: #deb887;">'Esimado Antonio, le informo que el plazo para la inscripcion finaliza el 30 de mayo.'</span>);
<span style="color: #00bfff;">INSERT</span> <span style="color: #00bfff;">INTO</span> contents <span style="color: #00bfff;">VALUES</span>(4,<span style="color: #deb887;">'Su compra se ha realizado correctamente. Gracias'</span>);
<span style="color: #00bfff;">INSERT</span> <span style="color: #00bfff;">INTO</span> contents <span style="color: #00bfff;">VALUES</span>(5,<span style="color: #deb887;">'Estimados alumnos, en el aula virtual pueden en contrar las calificaiones del examen'</span>);
<span style="color: #00bfff;">INSERT</span> <span style="color: #00bfff;">INTO</span> contents <span style="color: #00bfff;">VALUES</span>(6,<span style="color: #deb887;">'Hola mari, aqui te paso la receta del bizcocho ese que tanto te gusta'</span>);
<span style="color: #00bfff;">INSERT</span> <span style="color: #00bfff;">INTO</span> contents <span style="color: #00bfff;">VALUES</span>(7,<span style="color: #deb887;">'Antonio, en mi google-drive tienes las fotos del ultimo viaje.'</span>);
<span style="color: #00bfff;">DELETE</span> <span style="color: #00bfff;">FROM</span> sqlite_sequence;
<span style="color: #00bfff;">INSERT</span> <span style="color: #00bfff;">INTO</span> sqlite_sequence <span style="color: #00bfff;">VALUES</span>(<span style="color: #deb887;">'users'</span>,5);
<span style="color: #00bfff;">INSERT</span> <span style="color: #00bfff;">INTO</span> sqlite_sequence <span style="color: #00bfff;">VALUES</span>(<span style="color: #deb887;">'emails'</span>,7);
<span style="color: #00bfff;">COMMIT</span>;
</pre>
</div>
</div>
</div>

<div id="outline-container-org314fc28" class="outline-3">
<h3 id="org314fc28"><span class="section-number-3">7.2</span> Servidor HTTP</h3>
<div class="outline-text-3" id="text-7-2">
<p>
Se muestra a continuación el codigo fuente del servidor HTTP en su
totalidad,
</p>

<p>
Fichero: <b>server.js</b>
</p>
<div class="org-src-container">
<pre class="src src-js"><span style="color: #deb887;">'use strict'</span>;

<span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">Cargamos el modulo de Express</span>
<span style="color: #00bfff;">const</span> <span style="color: #4eee94;">express</span> = require(<span style="color: #deb887;">'express'</span>);

<span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">Crearmos un objeto servidor HTTP</span>
<span style="color: #00bfff;">const</span> <span style="color: #4eee94;">server</span> = express();

<span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">definimos el puerto a usar por el servidor HTTP</span>
<span style="color: #00bfff;">const</span> <span style="color: #4eee94;">port</span> = 8080;

<span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">Cargamos el modulo para la gestion de sesiones</span>
<span style="color: #00bfff;">const</span> <span style="color: #4eee94;">session</span> = require(<span style="color: #deb887;">'express-session'</span>);

<span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">Creamos el objeto con la configuraci&#243;n</span>
<span style="color: #00bfff;">const</span> <span style="color: #4eee94;">sesscfg</span> = {
    secret: <span style="color: #deb887;">'practicas-lsi-2023'</span>,
    resave: <span style="color: #a2cd5a;">false</span>,
    saveUninitialized: <span style="color: #a2cd5a;">true</span>,
    cookie: { maxAge: 8*60*60*1000 } <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">8 working hours</span>
};

<span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">Se le dice al servidor que use el modulo de sesiones con esa configuracion</span>
server.use(session(sesscfg));

<span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">Obtener la referencia al m&#243;dulo 'body-parser'</span>
<span style="color: #00bfff;">const</span> <span style="color: #4eee94;">bodyParser</span> = require(<span style="color: #deb887;">'body-parser'</span>);

<span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">Configuring express to use body-parser as middle-ware.</span>
server.use(bodyParser.urlencoded({ extended: <span style="color: #a2cd5a;">false</span> }));
server.use(bodyParser.json());

<span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">Obtener el configurador de rutas</span>
<span style="color: #00bfff;">const</span> <span style="color: #4eee94;">router</span> = express.Router();

<span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">cargar el m&#243;dulo para bases de datos SQLite</span>
<span style="color: #00bfff;">var</span> <span style="color: #4eee94;">sqlite3</span> = require(<span style="color: #deb887;">'sqlite3'</span>).verbose();

<span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">Abrir nuestra base de datos</span>
<span style="color: #00bfff;">var</span> <span style="color: #4eee94;">db</span> = <span style="color: #00bfff;">new</span> <span style="color: #98f5ff;">sqlite3.Database</span>(
    <span style="color: #deb887;">'emails.db'</span>,    <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">nombre del fichero de base de datos</span>
    (err) =&gt; { <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">funcion que ser&#225; invocada con el resultado</span>
        <span style="color: #00bfff;">if</span> (err)      <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">Si ha ocurrido un error</span>
            console.log(err);  <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">Mostrarlo por la consola del servidor</span>
    }
);

<span style="color: #00bfff;">function</span> <span style="color: #daa520;">processLogin</span>(<span style="color: #4eee94;">req</span>, <span style="color: #4eee94;">res</span>, <span style="color: #4eee94;">db</span>) {
    <span style="color: #00bfff;">var</span> <span style="color: #4eee94;">login</span> = req.body.user;
    <span style="color: #00bfff;">var</span> <span style="color: #4eee94;">passwd</span> = req.body.passwd;

    db.get(
        <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">consulta y par&#225;metros cuyo valor ser&#225; usado en los '?'</span>
        <span style="color: #deb887;">'SELECT * FROM users WHERE login=?'</span>, login,
        <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">funcion que se invocar&#225; con los datos obtenidos de la base de datos</span>
        (err, row) =&gt; {
            <span style="color: #00bfff;">if</span> (row == <span style="color: #a2cd5a;">undefined</span>) {
                <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">La consulta no devuelve ningun dato -: no existe el usuario</span>
                res.json({ errormsg: <span style="color: #deb887;">'El usuario no existe'</span>});
            } <span style="color: #00bfff;">else</span> <span style="color: #00bfff;">if</span> (row.passwd === passwd) {
                <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">La contrase&#241;a es correcta</span>
                <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">Asociar el userID a los datos de la sesi&#243;n</span>
                req.session.userID = row.id; <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">solo el id del usuario registrado</span>

                <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">Preparar los datos a enviar al navegador (AngularJS)</span>
                <span style="color: #00bfff;">var</span> <span style="color: #4eee94;">data</span> = {
                    id: row.id,
                    login: row.login,
                    name: row.name,
                    email: row.email
                };

                <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">enviar en la respuesta serializado en formato JSON</span>
                res.json(data);
            } <span style="color: #00bfff;">else</span> {
                <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">La contrase&#241;a no es correcta, -: enviar este otro mensaje</span>
                res.json({ errormsg: <span style="color: #deb887;">'Fallo de autenticaci&#243;n'</span>});
            }
        }
    );
}

<span style="color: #00bfff;">function</span> <span style="color: #daa520;">verificarUsuario</span>(<span style="color: #4eee94;">req</span>) {
    <span style="color: #00bfff;">return</span> req.session.userID != <span style="color: #a2cd5a;">undefined</span>;
}

<span style="color: #00bfff;">function</span> <span style="color: #daa520;">processListar</span>(<span style="color: #4eee94;">req</span>, <span style="color: #4eee94;">res</span>, <span style="color: #4eee94;">db</span>) {
    <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">recuperar el id del usuario de los datos asociados a la sesi&#243;n</span>
    <span style="color: #00bfff;">var</span> <span style="color: #4eee94;">userId</span> = req.session.userID;
    db.all(
        <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">consulta y par&#225;metros cuyo valor ser&#225; usado en los '?'</span>
        <span style="color: #deb887;">'SELECT id, subject, sender, date FROM emails WHERE user=?'</span>, userId,
        <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">funcion que se invocar&#225; con los datos obtenidos de la base de datos</span>
        (err, rows) =&gt; {
            <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">enviar en la respuesta serializado en formato JSON</span>
            res.json(rows);
        }
    );
}

<span style="color: #00bfff;">function</span> <span style="color: #daa520;">verificarEmail</span>(<span style="color: #4eee94;">req</span>, <span style="color: #4eee94;">db</span>, <span style="color: #4eee94;">validated</span>) {
    <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">Comprobar que hay un usuario registrado</span>
    <span style="color: #00bfff;">if</span> (!verificarUsuario(req)) {
        validated(<span style="color: #a2cd5a;">false</span>);;
    } <span style="color: #00bfff;">else</span> {
        <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">Comprobar si el email solicitado pertenece</span>
        <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">al usuario que se ha identificado</span>
        <span style="color: #00bfff;">var</span> <span style="color: #4eee94;">userId</span> = req.session.userID;
        <span style="color: #00bfff;">var</span> <span style="color: #4eee94;">emailId</span> = req.params.id;

        db.get(
            <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">Consulta para comprobar la pertenencia del email al usuario</span>
            <span style="color: #deb887;">'SELECT * FROM emails WHERE user=? AND id=?'</span>, [userId, emailId],
            (err, row) =&gt; {
                <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">Se asume que si exite es que es valido</span>
                validated(row != <span style="color: #a2cd5a;">undefined</span>);
            }
        );
    }
}

<span style="color: #00bfff;">function</span> <span style="color: #daa520;">processEmail</span>(<span style="color: #4eee94;">req</span>, <span style="color: #4eee94;">res</span>, <span style="color: #4eee94;">db</span>) {
    <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">El identificador del email est&#225; entre los parametros de la petici&#243;n</span>
    <span style="color: #00bfff;">var</span> <span style="color: #4eee94;">id</span> = req.params.id;
    <span style="color: #00bfff;">var</span> <span style="color: #4eee94;">sql</span> = <span style="color: #deb887;">'SELECT * FROM emails as E, contents as C WHERE E.id == C.id AND E.id=?'</span>;


    db.get(
        <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">consulta y par&#225;metros cuyo valor ser&#225; usado en los '?'</span>
        sql, id,
        (err, row) =&gt; {
            <span style="color: #00bfff;">if</span> (row == <span style="color: #a2cd5a;">undefined</span>) {
                res.json({ errormsg: <span style="color: #deb887;">'Error en la base de datos'</span>});
            } <span style="color: #00bfff;">else</span> {
                <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">enviar en la respuesta serializado en formato JSON</span>
                res.json(row);
            }
        }
    );
}

<span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">Ahora la acci&#243;n asociada al login ser&#237;a:</span>
router.post(<span style="color: #deb887;">'/login'</span>, (req, res) =&gt; {
    <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">Comprobar si la petici&#243;n contiene los campos ('user' y 'passwd')</span>
    <span style="color: #00bfff;">if</span> (!req.body.user || !req.body.passwd) {
        res.json({ errormsg: <span style="color: #deb887;">'Peticion mal formada'</span>});
    } <span style="color: #00bfff;">else</span> {
        <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">La petici&#243;n est&#225; bien formada -&gt; procesarla</span>
        processLogin(req, res, db); <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">Se la pasa tambien la base de datos</span>
    }
});

<span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">Configurar la accion asociada al listado de correos</span>
router.get(<span style="color: #deb887;">'/list'</span>, (req, res) =&gt; {
    <span style="color: #00bfff;">if</span> (verificarUsuario(req)) {
        processListar(req, res, db);
    } <span style="color: #00bfff;">else</span> {
        res.json({ errormsg: <span style="color: #deb887;">'Peticion mal formada'</span>});
    }
});

<span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">Configurar la accion asociada a la petici&#243;n del contenido de un correo</span>
router.get(<span style="color: #deb887;">'/email/:id'</span>, (req, res) =&gt; {
    verificarEmail(req, db, (valid) =&gt; {
        <span style="color: #00bfff;">if</span> (valid) {
            processEmail(req, res, db);
        } <span style="color: #00bfff;">else</span> {
            res.json({ errormsg: <span style="color: #deb887;">'Peticion mal formada'</span>});
        }
    });
});

<span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">A&#241;adir las rutas al servidor</span>
server.use(<span style="color: #deb887;">'/'</span>, router);

<span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">A&#241;adir las rutas est&#225;ticas al servidor.</span>
server.use(express.<span style="color: #00bfff;">static</span>(<span style="color: #deb887;">'.'</span>));

<span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">Poner en marcha el servidor ...</span>
server.listen(port, () =&gt; {
    console.log(<span style="color: #deb887;">`Servidor corriendo en el puerto ${port}`</span>);
});
</pre>
</div>
</div>
</div>


<div id="outline-container-org28a1e84" class="outline-3">
<h3 id="org28a1e84"><span class="section-number-3">7.3</span> Controladores AngularJS</h3>
<div class="outline-text-3" id="text-7-3">
<p>
Se presenta aquí el código fuente completo del controlador
AngularJS que interactua con el servidor HTTP en NodeJS.
</p>

<p>
Observe la implementacion de una factoria <code>emailService</code> que
transforma las llamadas a funciones Javascript en invocaciones al
API REsT mediante el servicio <code>$http</code>.
</p>

<p>
Fichero: <b>controller.js</b>
</p>
<div class="org-src-container">
<pre class="src src-js"><span style="color: #deb887;">'use strict'</span>;

angular.module(<span style="color: #deb887;">'AMail'</span>, [<span style="color: #deb887;">'ngRoute'</span>])
    .factory(<span style="color: #deb887;">'emailService'</span>, ($http) =&gt;{
        <span style="color: #00bfff;">var</span> <span style="color: #4eee94;">emailAPI</span> = {};

        emailAPI.login = <span style="color: #00bfff;">function</span>(<span style="color: #4eee94;">username</span>, <span style="color: #4eee94;">password</span>) {
            <span style="color: #00bfff;">return</span> $http({
                method : <span style="color: #deb887;">"POST"</span>,
                url : <span style="color: #deb887;">'/login'</span>,
                data : {
                    user : username,
                    passwd : password
                }
            });
        };

        emailAPI.logout = <span style="color: #00bfff;">function</span>() {
            <span style="color: #00bfff;">return</span> $http.get(<span style="color: #deb887;">'/logout'</span>);
        };

        emailAPI.list = <span style="color: #00bfff;">function</span>() {
            <span style="color: #00bfff;">return</span> $http.get(<span style="color: #deb887;">'/list'</span>);
        };

        emailAPI.email = <span style="color: #00bfff;">function</span>(<span style="color: #4eee94;">id</span>) {
            <span style="color: #00bfff;">return</span> $http.get(<span style="color: #deb887;">'/email/'</span> + id);
        };

        <span style="color: #00bfff;">return</span> emailAPI;
    })
    .config(<span style="color: #00bfff;">function</span>(<span style="color: #4eee94;">$routeProvider</span>) {
        $routeProvider.when(<span style="color: #deb887;">'/'</span>, {
            controller: <span style="color: #deb887;">'LoginController'</span>,
            templateUrl: <span style="color: #deb887;">'login.html'</span>
        }).when(<span style="color: #deb887;">'/list'</span>, {
            controller: <span style="color: #deb887;">'ListController'</span>,
            templateUrl: <span style="color: #deb887;">'list.html'</span>
        }).when(<span style="color: #deb887;">'/view/:id'</span>, {
            controller: <span style="color: #deb887;">'DetailController'</span>,
            templateUrl: <span style="color: #deb887;">'detail.html'</span>
        }).otherwise({
            redirectTo: <span style="color: #deb887;">'/'</span>
        });
    }).controller(<span style="color: #deb887;">'LoginController'</span>, <span style="color: #00bfff;">function</span>(<span style="color: #4eee94;">$scope</span>, <span style="color: #4eee94;">$location</span>, <span style="color: #4eee94;">emailService</span>) {
        $scope.registered = <span style="color: #a2cd5a;">false</span>;
        $scope.user = <span style="color: #deb887;">""</span>;
        $scope.passwd = <span style="color: #deb887;">""</span>;

        $scope.register = () =&gt; {
            emailService.login($scope.user, $scope.passwd)
                .then(<span style="color: #00bfff;">function</span>(<span style="color: #4eee94;">response</span>) {
                    $scope.registered = response.data.id != <span style="color: #a2cd5a;">undefined</span>;
                    <span style="color: #00bfff;">if</span> ($scope.registered) {
                        $scope.userdata = response.data;
                        $location.path(<span style="color: #deb887;">'/list'</span>);
                    }
                });
        };

        $scope.unregister = () =&gt; {
            $scope.registered = <span style="color: #a2cd5a;">false</span>;
            emailService.logout();
        };

    }).controller(<span style="color: #deb887;">'ListController'</span>, <span style="color: #00bfff;">function</span> (<span style="color: #4eee94;">$scope</span>, <span style="color: #4eee94;">emailService</span>) {
        $scope.messages = [];

        <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">Al entrar al controlador de la vista</span>
        <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">Solicitamos los datos al servidor</span>
        emailService.list().then(<span style="color: #00bfff;">function</span>(<span style="color: #4eee94;">response</span>) {
            $scope.messages = response.data;
        });

    }).controller(<span style="color: #deb887;">'DetailController'</span>, <span style="color: #00bfff;">function</span> (<span style="color: #4eee94;">$scope</span>, <span style="color: #4eee94;">$routeParams</span>, <span style="color: #4eee94;">emailService</span>) {
        $scope.params = $routeParams;

        $scope.message = {};

        <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">Al entrar al controlador de esta vista</span>
        <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">Solicitamos los datos al servidor</span>
        emailService.email(parseInt($routeParams.id)).then(<span style="color: #00bfff;">function</span>(<span style="color: #4eee94;">response</span>) {
            $scope.message = response.data;
        });
    });
</pre>
</div>
</div>
</div>

<div id="outline-container-orgbc8e992" class="outline-3">
<h3 id="orgbc8e992"><span class="section-number-3">7.4</span> Plantillas HTML</h3>
<div class="outline-text-3" id="text-7-4">
<p>
Fichero: <b>index.html</b>
</p>
<div class="org-src-container">
<pre class="src src-html">&lt;<span style="color: #daa520;">html</span> <span style="color: #4eee94;">ng-app</span>=<span style="color: #deb887;">"AMail"</span>&gt;
  &lt;<span style="color: #daa520;">head</span>&gt;
    &lt;<span style="color: #daa520;">meta</span> <span style="color: #4eee94;">charset</span>=<span style="color: #deb887;">"UTF-8"</span>&gt;
    &lt;<span style="color: #daa520;">script</span> <span style="color: #4eee94;">src</span>=<span style="color: #deb887;">"node_modules/angular/angular.min.js"</span>&gt;&lt;/<span style="color: #daa520;">script</span>&gt;
    &lt;<span style="color: #daa520;">script</span> <span style="color: #4eee94;">src</span>=<span style="color: #deb887;">"node_modules/angular-route/angular-route.min.js"</span>&gt;&lt;/<span style="color: #daa520;">script</span>&gt;
    &lt;<span style="color: #daa520;">script</span> <span style="color: #4eee94;">src</span>=<span style="color: #deb887;">"controllers.js"</span>&gt;&lt;/<span style="color: #daa520;">script</span>&gt;
  &lt;/<span style="color: #daa520;">head</span>&gt;
  &lt;<span style="color: #daa520;">body</span>&gt;
    &lt;<span style="color: #daa520;">h1</span>&gt;<span style="font-weight: bold; text-decoration: underline;">A-Mail</span>&lt;/<span style="color: #daa520;">h1</span>&gt;

    &lt;<span style="color: #daa520;">div</span> ng-view&gt;&lt;/<span style="color: #daa520;">div</span>&gt;

  &lt;/<span style="color: #daa520;">body</span>&gt;
&lt;/<span style="color: #daa520;">html</span>&gt;
</pre>
</div>

<p>
Fichero: <b>login.html</b>
</p>
<div class="org-src-container">
<pre class="src src-html">&lt;<span style="color: #daa520;">form</span>&gt;
  &lt;<span style="color: #daa520;">table</span>&gt;
    &lt;<span style="color: #daa520;">tr</span>&gt;
      &lt;<span style="color: #daa520;">td</span>&gt;Login:&lt;/<span style="color: #daa520;">td</span>&gt; &lt;<span style="color: #daa520;">td</span>&gt;&lt;<span style="color: #daa520;">input</span> <span style="color: #4eee94;">type</span>=<span style="color: #deb887;">"text"</span> <span style="color: #4eee94;">ng-model</span>=<span style="color: #deb887;">"user"</span>&gt;&lt;/<span style="color: #daa520;">td</span>&gt;
    &lt;/<span style="color: #daa520;">tr</span>&gt;
    &lt;<span style="color: #daa520;">tr</span>&gt;
      &lt;<span style="color: #daa520;">td</span>&gt;Password:&lt;/<span style="color: #daa520;">td</span>&gt; &lt;<span style="color: #daa520;">td</span>&gt;&lt;<span style="color: #daa520;">input</span> <span style="color: #4eee94;">type</span>=<span style="color: #deb887;">"password"</span> <span style="color: #4eee94;">ng-model</span>=<span style="color: #deb887;">"passwd"</span>&gt;&lt;/<span style="color: #daa520;">td</span>&gt;
    &lt;/<span style="color: #daa520;">tr</span>&gt;
  &lt;/<span style="color: #daa520;">table</span>&gt;
  &lt;<span style="color: #daa520;">button</span> <span style="color: #4eee94;">ng-click</span>=<span style="color: #deb887;">"register()"</span>&gt;Identify&lt;/<span style="color: #daa520;">button</span>&gt;
&lt;/<span style="color: #daa520;">form</span>&gt;
</pre>
</div>

<p>
Fichero: <b>list.html</b>
</p>
<div class="org-src-container">
<pre class="src src-html">&lt;<span style="color: #daa520;">table</span>&gt;
   &lt;<span style="color: #daa520;">tr</span>&gt;
      &lt;<span style="color: #daa520;">td</span>&gt;&lt;<span style="color: #daa520;">strong</span>&gt;<span style="font-weight: bold;">Sender</span>&lt;/<span style="color: #daa520;">strong</span>&gt;&lt;/<span style="color: #daa520;">td</span>&gt;
      &lt;<span style="color: #daa520;">td</span>&gt;&lt;<span style="color: #daa520;">strong</span>&gt;<span style="font-weight: bold;">Subject</span>&lt;/<span style="color: #daa520;">strong</span>&gt;
      &lt;/<span style="color: #daa520;">td</span>&gt; &lt;<span style="color: #daa520;">td</span>&gt;&lt;<span style="color: #daa520;">strong</span>&gt;<span style="font-weight: bold;">Date</span>&lt;/<span style="color: #daa520;">strong</span>&gt;&lt;/<span style="color: #daa520;">td</span>&gt;
   &lt;/<span style="color: #daa520;">tr</span>&gt;
   &lt;<span style="color: #daa520;">tr</span> <span style="color: #4eee94;">ng-repeat</span>=<span style="color: #deb887;">'message in messages'</span>&gt;
      &lt;<span style="color: #daa520;">td</span>&gt;{{message.sender}}&lt;/<span style="color: #daa520;">td</span>&gt;
      &lt;<span style="color: #daa520;">td</span>&gt;&lt;<span style="color: #daa520;">a</span> <span style="color: #4eee94;">href</span>=<span style="color: #deb887;">'#!/view/{{message.id}}'</span>&gt;{{message.subject}}&lt;/<span style="color: #daa520;">td</span>&gt;
      &lt;<span style="color: #daa520;">td</span>&gt;{{message.date}}&lt;/<span style="color: #daa520;">td</span>&gt;
   &lt;/<span style="color: #daa520;">tr</span>&gt;
&lt;/<span style="color: #daa520;">table</span>&gt;
</pre>
</div>

<p>
Fichero: <b>detail.html</b>
</p>
<div class="org-src-container">
<pre class="src src-html">&lt;<span style="color: #daa520;">p</span>&gt;&lt;<span style="color: #daa520;">strong</span>&gt;<span style="font-weight: bold;">Subject:</span>&lt;/<span style="color: #daa520;">strong</span>&gt; {{message.subject}}&lt;/<span style="color: #daa520;">p</span>&gt;
&lt;<span style="color: #daa520;">p</span>&gt;&lt;<span style="color: #daa520;">strong</span>&gt;<span style="font-weight: bold;">Sender:</span>&lt;/<span style="color: #daa520;">strong</span>&gt; {{message.sender}}&lt;/<span style="color: #daa520;">p</span>&gt;
&lt;<span style="color: #daa520;">p</span>&gt;&lt;<span style="color: #daa520;">strong</span>&gt;<span style="font-weight: bold;">Date:</span>&lt;/<span style="color: #daa520;">strong</span>&gt; {{message.date}}&lt;/<span style="color: #daa520;">p</span>&gt;
&lt;<span style="color: #daa520;">p</span>&gt; &lt;<span style="color: #daa520;">strong</span>&gt;<span style="font-weight: bold;">To:</span>&lt;/<span style="color: #daa520;">strong</span>&gt;
   &lt;<span style="color: #daa520;">span</span> <span style="color: #4eee94;">ng-repeat</span>=<span style="color: #deb887;">'recipient in message.recipients'</span>&gt;{{recipient}} &lt;/<span style="color: #daa520;">span</span>&gt;
&lt;/<span style="color: #daa520;">p</span>&gt;
&lt;<span style="color: #daa520;">div</span>&gt;{{message.content}}&lt;/<span style="color: #daa520;">div</span>&gt;
&lt;<span style="color: #daa520;">a</span> <span style="color: #4eee94;">href</span>=<span style="color: #deb887;">'#!/list'</span>&gt;Back to message list&lt;/<span style="color: #daa520;">a</span>&gt;
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Antonio Manuel</p>
<p class="date">Created: 2023-05-25 jue 19:58</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
